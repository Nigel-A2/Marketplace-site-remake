!function(i){"function"==typeof define&&define.amd?define(["jquery"],i):i(jQuery)}(function(a){"use strict";var i=0;function n(i,t){this.container=i,this.options=t,this.container.trigger("mosaicflow-start"),this.init(),this.container.trigger("mosaicflow-ready")}a.fn.mosaicflow=function(s){var e=Array.prototype.slice.call(arguments,0);return this.each(function(){var i=a(this),t=i.data("mosaicflow");t?"string"==typeof s&&t[s](e[1]):(t=new n(i,s=a.extend({},a.fn.mosaicflow.defaults,s,function(i){function t(i,t){return t.toUpper()}var s,e={},n=i.data();for(s in n)e[s.replace(/-(\w)/g,t)]=n[s];return e}(i))),i.data("mosaicflow",t))})},a.fn.mosaicflow.defaults={itemSelector:"> *",columnClass:"mosaicflow__column",minItemWidth:240,minColumns:2,itemHeightCalculation:"auto",threshold:40},n.prototype={init:function(){this.__uid=i++,this.__uidItemCounter=0,this.items=this.container.find(this.options.itemSelector),this.columns=a([]),this.columnsHeights=[],this.itemsHeights={},this.tempContainer=a("<div>").css({visibility:"hidden",width:"100%"}),this.workOnTemp=!1,this.autoCalculation="auto"===this.options.itemHeightCalculation,this.container.append(this.tempContainer);var s=this;this.items.each(function(){var i,t=a(this);t.attr("id")||(i=s.generateUniqueId(),t.attr("id",i))}),this.container.css("visibility","hidden"),this.autoCalculation?a(window).on("load",a.proxy(this.refill,this)):this.refill(),a(window).resize(a.proxy(this.refill,this))},refill:function(){this.container.trigger("mosaicflow-fill"),this.numberOfColumns=Math.floor(this.container.width()/this.options.minItemWidth),this.numberOfColumns<this.options.minColumns&&(this.numberOfColumns=this.options.minColumns),this.ensureColumns()&&(this.fillColumns(),0<this.columns.filter(":visible").length&&this.columns.filter(":hidden").remove()),this.container.css("visibility","visible"),this.container.trigger("mosaicflow-filled")},ensureColumns:function(){var i=this.columns.filter(":visible").length,t=this.numberOfColumns;if(this.workingContainer=0===i?this.tempContainer:this.container,i<t)for(var s=t-i,e=0;e<s;e++){var n=a("<div>",{class:this.options.columnClass});this.workingContainer.append(n)}else if(t<i){for(var o=i;t<=o;)this.columns.eq(o).hide(),o--;var h=i-t;this.columnsHeights.splice(this.columnsHeights.length-h,h)}return t!==i&&(this.columns=this.workingContainer.find("."+this.options.columnClass),this.columns.css("width",100/t+"%"),!0)},fillColumns:function(){for(var i=this.numberOfColumns,t=this.items.length,s=0;s<i;s++){var e=this.columns.eq(s);this.columnsHeights[s]=0;for(var n=s;n<t;n+=i){var o=this.items.eq(n),h=0;e.append(o),h=this.autoCalculation?o.outerHeight():parseInt(o.find("img").attr("height"),10),this.itemsHeights[o.attr("id")]=h,this.columnsHeights[s]+=h}}this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.workingContainer===this.tempContainer&&this.container.append(this.tempContainer.children()),this.container.trigger("mosaicflow-layout")},levelBottomEdge:function(i,t){for(;;){var s=a.inArray(Math.min.apply(null,t),t),e=a.inArray(Math.max.apply(null,t),t);if(s===e)return;var n=this.columns.eq(e).children().last(),o=i[n.attr("id")],h=t[s],r=t[e],h=h+o;if(r<=h)return;if(r-h<this.options.threshold)return;this.columns.eq(s).append(n),t[e]-=o,t[s]+=o}},add:function(i){this.container.trigger("mosaicflow-item-add",[i]);var t=a.inArray(Math.min.apply(null,this.columnsHeights),this.columnsHeights),s=0,e=(this.autoCalculation?(i.css({position:"static",visibility:"hidden",display:"block"}).appendTo(this.columns.eq(t)),s=i.outerHeight(),0!==(e=i.find("img")).length&&e.each(function(){var i=a(this),t=function(i){var t={};{var s;t.height=parseInt(i.attr("height"),10),t.width=parseInt(i.attr("width"),10),0!==t.height&&0!==t.width||((s=new Image).src=i.attr("src"),t.width=s.width,t.height=s.height)}return t}(i),i=i.width()*t.height/t.width;s+=i}),i.detach().css({position:"static",visibility:"visible"})):s=parseInt(i.find("img").attr("height"),10),i.attr("id")||i.attr("id",this.generateUniqueId()),this.items.toArray());e.push(i),this.items=a(e),this.itemsHeights[i.attr("id")]=s,this.columnsHeights[t]+=s,this.columns.eq(t).append(i),this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.container.trigger("mosaicflow-layout"),this.container.trigger("mosaicflow-item-added",[i])},remove:function(i){this.container.trigger("mosaicflow-item-remove",[i]);var t=i.parents("."+this.options.columnClass);this.columnsHeights[t.index()-1]-=this.itemsHeights[i.attr("id")],i.detach(),this.items=this.items.not(i),this.levelBottomEdge(this.itemsHeights,this.columnsHeights),this.container.trigger("mosaicflow-layout"),this.container.trigger("mosaicflow-item-removed",[i])},empty:function(){var i=this.numberOfColumns;this.items=a([]),this.itemsHeights={};for(var t=0;t<i;t++){var s=this.columns.eq(t);this.columnsHeights[t]=0,s.empty()}this.container.trigger("mosaicflow-layout")},recomputeHeights:function(){function i(i,t){t=a(t);var s=0,s=e.autoCalculation?t.outerHeight():parseInt(t.find("img").attr("height"),10);e.itemsHeights[t.attr("id")]=s,e.columnsHeights[n]+=s}for(var e=this,t=this.numberOfColumns,n=0;n<t;n++){var s=this.columns.eq(n);this.columnsHeights[n]=0,s.children().each(i)}},generateUniqueId:function(){return this.__uidItemCounter++,"mosaic-"+this.__uid+"-itemid-"+this.__uidItemCounter}},a(function(){a(".mosaicflow").mosaicflow()})});